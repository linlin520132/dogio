<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title class="zh">深度共识者公示 - DOG Miner</title>
    <title class="en hidden">Deep Consensus Monitor - DOG Miner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6C5CE7',
                        secondary: '#00F5D4',
                        dark: '#0F172A',
                        darker: '#0A0F1C',
                        light: '#E2E8F0',
                        danger: '#EF4444',
                        success: '#10B981',
                        warning: '#F59E0B'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .text-gradient {
                background-clip: text;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            .bg-grid {
                background-image: radial-gradient(rgba(108, 92, 231, 0.1) 1px, transparent 1px);
                background-size: 20px 20px;
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-10px);
                box-shadow: 0 20px 25px -5px rgba(108, 92, 231, 0.1), 0 10px 10px -5px rgba(108, 92, 231, 0.04);
            }
            .modal-backdrop {
                backdrop-filter: blur(8px);
                background-color: rgba(10, 15, 28, 0.7);
            }
            .animate-scale-in {
                animation: scaleIn 0.3s ease-out;
            }
            @keyframes scaleIn {
                from {
                    opacity: 0;
                    transform: scale(0.9);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }
            /* 表格移动端优化 */
            @media (max-width: 768px) {
                .table-container {
                    font-size: 0.875rem;
                }
                .table-container th,
                .table-container td {
                    padding: 0.5rem 0.25rem;
                }
                .table-container .min-w-200px {
                    min-width: 140px;
                }
                .table-container .text-sm {
                    font-size: 0.75rem;
                }
            }
            .animate-pulse-green {
                animation: pulseGreen 2s infinite;
            }
            @keyframes pulseGreen {
                0%, 100% { background-color: rgba(16, 185, 129, 0.1); }
                50% { background-color: rgba(16, 185, 129, 0.3); }
            }
            .animate-pulse-red {
                animation: pulseRed 2s infinite;
            }
            @keyframes pulseRed {
                0%, 100% { background-color: rgba(239, 68, 68, 0.1); }
                50% { background-color: rgba(239, 68, 68, 0.3); }
            }

            /* 排序功能样式 */
            .sortable-header {
                user-select: none;
                transition: all 0.2s ease;
            }
            .sortable-header:hover {
                background-color: rgba(108, 92, 231, 0.05);
            }
            .sort-icons {
                line-height: 0.75rem;
            }
            .sort-up, .sort-down {
                transition: all 0.2s ease;
            }
            /* Tab 按钮样式 */
            .tab-button {
                position: relative;
            }
            .tab-button.active {
                color: #00F5D4;
            }
            .tab-button:not(.active) {
                color: rgba(226, 232, 240, 0.6);
            }
            .tab-button:not(.active):hover {
                color: rgba(226, 232, 240, 0.9);
            }
        }
    </style>
</head>
<body class="bg-dark text-light antialiased">
    <!-- 导航栏 -->
    <nav class="fixed w-full z-50 bg-darker/80 backdrop-blur-md border-b border-primary/20">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <img src="./9CC7AD3CC2590115FAE5FF84D02BCD74.png" style="width: 32px;">
                <span class="text-xl font-bold text-white">DOG</span>
            </div>

            <div class="flex items-center space-x-4">
                <!-- 语言切换 -->
                <button id="lang-zh" class="text-secondary font-medium">中文</button>
                <button id="lang-en" class="text-light/60 hover:text-secondary transition-colors">English</button>

                <a href="./index.html" class="text-light/60 hover:text-secondary transition-colors">
                    <i class="fa fa-home mr-1"></i><span class="zh">主页</span><span class="en hidden">Home</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="pt-24 pb-2 bg-grid relative">
        <div class="absolute inset-0 bg-gradient-to-b from-primary/5 to-darker"></div>
        <div class="container mx-auto px-4 relative z-10">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-8">
                    <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold mb-4">
                        <span class="zh bg-gradient-to-r from-primary to-secondary text-gradient">深度共识者公示</span>
                        <span class="en hidden bg-gradient-to-r from-primary to-secondary text-gradient">Deep Consensus Monitor</span>
                    </h1>
                    <p class="text-light/70 max-w-2xl mx-auto zh">
                        深度共识者自愿公示地址，接受查询DOG持仓变化
                    </p>
                    <p class="text-light/70 max-w-2xl mx-auto en hidden">
                        Deep consensus participants voluntarily display their addresses for DOG token balance monitoring, keeping track of changes in real-time.
                    </p>
                    <p class="text-light/70 max-w-2xl mx-auto zh">
                        （调用okx官方接口，每10分钟查询一次）
                    </p>
                    <p class="text-light/70 max-w-2xl mx-auto en hidden">
                        (Calling OKX official API, updated every 10 minutes.)
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户持仓监控 -->
    <section class="py-4 bg-dark">
        <div class="container mx-auto px-4">
            <div class="max-w-6xl mx-auto">
                <div class="bg-darker rounded-2xl p-6 border border-primary/20">
                    <!-- 统计信息 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-dark/50 rounded-lg p-4 border border-primary/10">
                            <div class="text-sm text-light/60 mb-1 zh">上次更新时间 (UTC+8)</div>
                            <div class="text-sm text-light/60 mb-1 en hidden">Last Update (UTC+8)</div>
                            <div class="text-lg font-bold text-white" id="last-update-time">-</div>
                        </div>
                        <div class="bg-dark/50 rounded-lg p-4 border border-primary/10">
                            <div class="text-sm text-light/60 mb-1 zh">当前深度共识者总人数</div>
                            <div class="text-sm text-light/60 mb-1 en hidden">Total Deep Consensus Participants</div>
                            <div class="text-lg font-bold text-secondary" id="total-users">-</div>
                        </div>
                        <div class="bg-dark/50 rounded-lg p-4 border border-primary/10">
                            <div class="text-sm text-light/60 mb-1 zh">当前深度共识者总持仓</div>
                            <div class="text-sm text-light/60 mb-1 en hidden">Total Deep Consensus Balance</div>
                            <div class="text-lg font-bold text-primary" id="total-balance">-</div>
                        </div>
                    </div>

                    <!-- Tab 切换 -->
                    <div class="flex justify-center border-b border-primary/20 mb-6">
                        <button id="tab-large" class="tab-button active px-6 py-3 text-base font-medium transition-colors border-b-2 border-secondary text-secondary">
                            <span class="zh">持仓≥1亿</span>
                            <span class="en hidden">Balance ≥100M</span>
                            <span id="tab-large-count" class="ml-2 text-sm opacity-70">(0)</span>
                        </button>
                        <button id="tab-small" class="tab-button px-6 py-3 text-base font-medium transition-colors border-b-2 border-transparent text-light/60 hover:text-light">
                            <span class="zh">持仓≥2000万</span>
                            <span class="en hidden">Balance ≥20M</span>
                            <span id="tab-small-count" class="ml-2 text-sm opacity-70">(0)</span>
                        </button>
                    </div>

                    <!-- 持仓≥1亿表格 -->
                    <div id="table-large" class="table-tab-content">
                        <div class="overflow-x-auto table-container">
                            <table class="w-full text-left min-w-[800px]">
                                <thead>
                                    <tr class="border-b border-primary/20">
                                        <th class="pb-3 text-light/80 font-medium min-w-[100px] w-[120px]">
                                            <span class="zh">昵称</span>
                                            <span class="en hidden">Nickname</span>
                                        </th>
                                        <th class="pb-3 text-light/80 font-medium min-w-[120px] w-[150px]">
                                            <span class="zh">钱包地址</span>
                                            <span class="en hidden">Wallet Address</span>
                                        </th>
                                        <th class="pb-3 text-light/80 font-medium min-w-[120px] w-[140px]">
                                            <span class="zh">当前持仓</span>
                                            <span class="en hidden">Current Balance</span>
                                        </th>
                                        <th class="pb-3 text-light/80 font-medium min-w-[130px] w-[150px] cursor-pointer hover:text-secondary transition-colors sortable-header" data-sort="totalBalance" data-tab="large">
                                            <div class="flex items-center">
                                                <span>
                                                    <span class="zh">当前持仓合计</span>
                                                    <span class="en hidden">Total Current Balance</span>
                                                </span>
                                                <div class="sort-icons flex flex-col ml-2">
                                                    <i class="fa fa-chevron-up text-xs opacity-30 sort-up"></i>
                                                    <i class="fa fa-chevron-down text-xs opacity-30 sort-down"></i>
                                                </div>
                                            </div>
                                        </th>
                                        <th class="pb-3 text-light/80 font-medium min-w-[130px] w-[150px] cursor-pointer hover:text-secondary transition-colors sortable-header" data-sort="initialBalanceTotal" data-tab="large">
                                            <div class="flex items-center">
                                                <span>
                                                    <span class="zh">加入时初始持仓</span>
                                                    <span class="en hidden">Initial Balance Total</span>
                                                </span>
                                                <div class="sort-icons flex flex-col ml-2">
                                                    <i class="fa fa-chevron-up text-xs opacity-30 sort-up"></i>
                                                    <i class="fa fa-chevron-down text-xs opacity-30 sort-down"></i>
                                                </div>
                                            </div>
                                        </th>
                                        <th class="pb-3 text-light/80 font-medium min-w-[100px] w-[120px] cursor-pointer hover:text-secondary transition-colors sortable-header" data-sort="percentage" data-tab="large">
                                            <div class="flex items-center">
                                                <span>
                                                    <span class="zh">变化百分比</span>
                                                    <span class="en hidden">Change %</span>
                                                </span>
                                                <div class="sort-icons flex flex-col ml-2">
                                                    <i class="fa fa-chevron-up text-xs opacity-30 sort-up"></i>
                                                    <i class="fa fa-chevron-down text-xs opacity-30 sort-down"></i>
                                                </div>
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="balance-table-body-large">
                                    <tr>
                                        <td colspan="6" class="text-center text-light/50 py-8">
                                            <i class="fa fa-info-circle text-2xl mb-2"></i>
                                            <p class="zh">暂无用户数据</p>
                                            <p class="en hidden">No user data available</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 持仓<1亿表格 -->
                    <div id="table-small" class="table-tab-content hidden">
                        <div class="overflow-x-auto table-container">
                            <table class="w-full text-left min-w-[800px]">
                                <thead>
                                    <tr class="border-b border-primary/20">
                                        <th class="pb-3 text-light/80 font-medium min-w-[100px] w-[120px]">
                                            <span class="zh">昵称</span>
                                            <span class="en hidden">Nickname</span>
                                        </th>
                                        <th class="pb-3 text-light/80 font-medium min-w-[120px] w-[150px]">
                                            <span class="zh">钱包地址</span>
                                            <span class="en hidden">Wallet Address</span>
                                        </th>
                                        <th class="pb-3 text-light/80 font-medium min-w-[120px] w-[140px]">
                                            <span class="zh">当前持仓</span>
                                            <span class="en hidden">Current Balance</span>
                                        </th>
                                        <th class="pb-3 text-light/80 font-medium min-w-[130px] w-[150px] cursor-pointer hover:text-secondary transition-colors sortable-header" data-sort="totalBalance" data-tab="small">
                                            <div class="flex items-center">
                                                <span>
                                                    <span class="zh">当前持仓合计</span>
                                                    <span class="en hidden">Total Current Balance</span>
                                                </span>
                                                <div class="sort-icons flex flex-col ml-2">
                                                    <i class="fa fa-chevron-up text-xs opacity-30 sort-up"></i>
                                                    <i class="fa fa-chevron-down text-xs opacity-30 sort-down"></i>
                                                </div>
                                            </div>
                                        </th>
                                        <th class="pb-3 text-light/80 font-medium min-w-[130px] w-[150px] cursor-pointer hover:text-secondary transition-colors sortable-header" data-sort="initialBalanceTotal" data-tab="small">
                                            <div class="flex items-center">
                                                <span>
                                                    <span class="zh">加入时初始持仓</span>
                                                    <span class="en hidden">Initial Balance Total</span>
                                                </span>
                                                <div class="sort-icons flex flex-col ml-2">
                                                    <i class="fa fa-chevron-up text-xs opacity-30 sort-up"></i>
                                                    <i class="fa fa-chevron-down text-xs opacity-30 sort-down"></i>
                                                </div>
                                            </div>
                                        </th>
                                        <th class="pb-3 text-light/80 font-medium min-w-[100px] w-[120px] cursor-pointer hover:text-secondary transition-colors sortable-header" data-sort="percentage" data-tab="small">
                                            <div class="flex items-center">
                                                <span>
                                                    <span class="zh">变化百分比</span>
                                                    <span class="en hidden">Change %</span>
                                                </span>
                                                <div class="sort-icons flex flex-col ml-2">
                                                    <i class="fa fa-chevron-up text-xs opacity-30 sort-up"></i>
                                                    <i class="fa fa-chevron-down text-xs opacity-30 sort-down"></i>
                                                </div>
                                            </div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="balance-table-body-small">
                                    <tr>
                                        <td colspan="6" class="text-center text-light/50 py-8">
                                            <i class="fa fa-info-circle text-2xl mb-2"></i>
                                            <p class="zh">暂无用户数据</p>
                                            <p class="en hidden">No user data available</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 页脚 -->
    <footer class="bg-darker border-t border-primary/20 py-8">
        <div class="container mx-auto px-4">
            <div class="text-center text-light/60 text-sm">
                <p class="zh">© 2025 DOG代币深度共识者公示系统. 数据来源于OKX API</p>
                <p class="en hidden">© 2025 DOG Token Deep Consensus Monitor. Data sourced from OKX API</p>
            </div>
        </div>
    </footer>


    <script>
        // 缓存相关常量
        const CACHE_KEY = 'dog_balance_data';
        const CACHE_DURATION = 10 * 60 * 1000; // 10分钟

        // 获取缓存的数据
        function getCachedData() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (!cached) return null;

                const { data, timestamp } = JSON.parse(cached);
                const now = Date.now();

                // 检查是否在10分钟内
                if (now - timestamp < CACHE_DURATION) {
                    console.log(`缓存数据有效，剩余时间: ${Math.round((CACHE_DURATION - (now - timestamp)) / 1000 / 60)} 分钟`);
                    return data;
                } else {
                    console.log('缓存数据已过期');
                    localStorage.removeItem(CACHE_KEY);
                    return null;
                }
            } catch (error) {
                console.error('读取缓存数据失败:', error);
                localStorage.removeItem(CACHE_KEY);
                return null;
            }
        }

        // 缓存数据
        function cacheData(data) {
            try {
                const cacheData = {
                    data: data,
                    timestamp: Date.now()
                };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
                console.log('数据已缓存到本地存储');
            } catch (error) {
                console.error('缓存数据失败:', error);
            }
        }

        const API_BASE_URL = 'https://dogapi.leezf.top'; 

        // DOM元素
        const balanceTableBodyLarge = document.getElementById('balance-table-body-large');
        const balanceTableBodySmall = document.getElementById('balance-table-body-small');
        const lastUpdateTimeEl = document.getElementById('last-update-time');
        const totalUsersEl = document.getElementById('total-users');
        const totalBalanceEl = document.getElementById('total-balance');
        const tabLargeBtn = document.getElementById('tab-large');
        const tabSmallBtn = document.getElementById('tab-small');
        const tabLargeCount = document.getElementById('tab-large-count');
        const tabSmallCount = document.getElementById('tab-small-count');
        const tableLarge = document.getElementById('table-large');
        const tableSmall = document.getElementById('table-small');

        // 当前激活的 tab
        let currentTab = 'large'; // 'large' 或 'small'

        // 排序状态管理（为每个 tab 独立维护）
        let sortState = {
            large: { field: null, order: null },
            small: { field: null, order: null }
        };
        
        // 用户数据分组
        let usersLarge = []; // 持仓≥1亿
        let usersSmall = []; // 持仓<1亿

        // 页面加载时获取表格数据
        window.addEventListener('load', () => {
            loadBalanceData();
            initializeSorting();
            initializeTabs();
        });

        // 初始化 Tab 切换
        function initializeTabs() {
            tabLargeBtn.addEventListener('click', () => switchTab('large'));
            tabSmallBtn.addEventListener('click', () => switchTab('small'));
        }

        // 切换 Tab
        function switchTab(tab) {
            currentTab = tab;
            
            if (tab === 'large') {
                tabLargeBtn.classList.add('active', 'border-secondary', 'text-secondary');
                tabLargeBtn.classList.remove('border-transparent', 'text-light/60');
                tabSmallBtn.classList.remove('active', 'border-secondary', 'text-secondary');
                tabSmallBtn.classList.add('border-transparent', 'text-light/60');
                tableLarge.classList.remove('hidden');
                tableSmall.classList.add('hidden');
            } else {
                tabSmallBtn.classList.add('active', 'border-secondary', 'text-secondary');
                tabSmallBtn.classList.remove('border-transparent', 'text-light/60');
                tabLargeBtn.classList.remove('active', 'border-secondary', 'text-secondary');
                tabLargeBtn.classList.add('border-transparent', 'text-light/60');
                tableSmall.classList.remove('hidden');
                tableLarge.classList.add('hidden');
            }
            
            // 更新排序图标显示
            updateSortIcons();
        }

        // 更新统计信息
        function updateStatistics(data, isFromCache = false) {
            // 更新上次更新时间 (UTC+8)
            if (data.lastUpdate) {
                const timeText = formatTimeToUTC8(data.lastUpdate);
                lastUpdateTimeEl.textContent = isFromCache ? `${timeText} (缓存)` : timeText;
                lastUpdateTimeEl.title = isFromCache ? '数据来自本地缓存' : '数据来自最新请求';
            }

            // 更新共识者总人数
            if (data.totalUsers !== undefined) {
                totalUsersEl.textContent = data.totalUsers;
            }

            // 计算并更新当前总持仓
            if (data.users && data.users.length > 0) {
                const totalBalance = data.users.reduce((sum, user) => sum + (user.totalBalance || 0), 0);
                totalBalanceEl.textContent = Math.round(totalBalance).toLocaleString();
            }
        }

        // 将时间格式化为UTC+8
        function formatTimeToUTC8(isoString) {
            try {
                const date = new Date(isoString);
                // 转换为UTC+8
                const utc8Time = new Date(date.getTime());

                // 格式化为本地化字符串
                return utc8Time.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            } catch (error) {
                console.error('时间格式化失败:', error);
                return isoString; // 返回原始字符串作为fallback
            }
        }

        // 初始化排序功能
        function initializeSorting() {
            // 为所有可排序的表头添加点击事件
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', () => {
                    const sortField = header.dataset.sort;
                    const tab = header.dataset.tab;
                    handleSort(sortField, tab);
                });
            });
        }

        // 处理排序
        function handleSort(field, tab) {
            const state = sortState[tab];
            
            // 如果点击的是当前排序字段，则循环排序顺序
            if (state.field === field) {
                // 循环: 无序 -> 倒序 -> 正序 -> 无序
                if (state.order === null) {
                    state.order = 'desc';
                } else if (state.order === 'desc') {
                    state.order = 'asc';
                } else {
                    state.order = null;
                    state.field = null;
                }
            } else {
                // 点击新字段，开始倒序排序（大值在前）
                state.field = field;
                state.order = 'desc';
            }

            // 更新UI
            updateSortIcons();

            // 重新渲染当前 tab 的表格
            renderSortedTable(tab);
        }

        // 更新排序图标显示
        function updateSortIcons() {
            // 重置所有图标
            document.querySelectorAll('.sort-up, .sort-down').forEach(icon => {
                icon.classList.add('opacity-30');
                icon.classList.remove('text-secondary');
            });

            // 更新当前 tab 的排序图标
            const state = sortState[currentTab];
            if (state.field && state.order) {
                const currentHeader = document.querySelector(`[data-sort="${state.field}"][data-tab="${currentTab}"]`);
                if (currentHeader) {
                    const iconClass = state.order === 'asc' ? '.sort-up' : '.sort-down';
                    const icon = currentHeader.querySelector(iconClass);
                    if (icon) {
                        icon.classList.remove('opacity-30');
                        icon.classList.add('text-secondary');
                    }
                }
            }
        }

        // 渲染排序后的表格
        function renderSortedTable(tab = currentTab) {
            const state = sortState[tab];
            let usersToRender = tab === 'large' ? [...usersLarge] : [...usersSmall];

            // 如果有排序，应用排序
            if (state.field && state.order) {
                usersToRender.sort((a, b) => {
                    let aValue = a[state.field];
                    let bValue = b[state.field];

                    // 确保数值比较
                    if (typeof aValue === 'string') aValue = parseFloat(aValue) || 0;
                    if (typeof bValue === 'string') bValue = parseFloat(bValue) || 0;

                    if (state.order === 'asc') {
                        return aValue - bValue;
                    } else {
                        return bValue - aValue;
                    }
                });
            }

            // 渲染对应表格
            if (tab === 'large') {
                balanceTableBodyLarge.innerHTML = renderTableHTML(usersToRender);
            } else {
                balanceTableBodySmall.innerHTML = renderTableHTML(usersToRender);
            }
        }

        // 语言切换功能
        document.getElementById('lang-zh').addEventListener('click', function() {
            document.querySelectorAll('.zh').forEach(el => el.classList.remove('hidden'));
            document.querySelectorAll('.en').forEach(el => el.classList.add('hidden'));
            document.documentElement.lang = 'zh-CN';
            document.getElementById('lang-zh').classList.add('text-secondary');
            document.getElementById('lang-zh').classList.remove('text-light/60');
            document.getElementById('lang-en').classList.remove('text-secondary');
            document.getElementById('lang-en').classList.add('text-light/60');
        });

        document.getElementById('lang-en').addEventListener('click', function() {
            document.querySelectorAll('.en').forEach(el => el.classList.remove('hidden'));
            document.querySelectorAll('.zh').forEach(el => el.classList.add('hidden'));
            document.documentElement.lang = 'en';
            document.getElementById('lang-en').classList.add('text-secondary');
            document.getElementById('lang-en').classList.remove('text-light/60');
            document.getElementById('lang-zh').classList.remove('text-secondary');
            document.getElementById('lang-zh').classList.add('text-light/60');
        });

        // 处理API响应的函数
        function handleApiResponse(responseText) {
            try {
                const response = JSON.parse(responseText);

                if (response.success && response.data) {
                    const allUsers = response.data.users;
                    const threshold = 100000000; // 1亿

                    // 将用户数据分成两组
                    usersLarge = allUsers.filter(user => (user.totalBalance || 0) >= threshold);
                    usersSmall = allUsers.filter(user => (user.totalBalance || 0) < threshold);

                    // 更新 tab 计数
                    tabLargeCount.textContent = `(${usersLarge.length})`;
                    tabSmallCount.textContent = `(${usersSmall.length})`;

                    // 重置排序状态（新数据到来时）
                    sortState.large = { field: null, order: null };
                    sortState.small = { field: null, order: null };
                    updateSortIcons();

                    // 缓存成功的数据
                    cacheData(response);

                    // 更新统计信息
                    updateStatistics(response.data, false);

                    // 渲染两个表格
                    renderSortedTable('large');
                    renderSortedTable('small');

                    console.log(`持仓数据已加载，最后更新时间: ${response.data.lastUpdate}`);
                    console.log(`持仓≥1亿: ${usersLarge.length}人，持仓<1亿: ${usersSmall.length}人`);
                } else {
                    throw new Error('后端API返回数据格式错误');
                }
            } catch (error) {
                console.error('处理持仓数据失败:', error);
                const errorHtml = `
                    <tr>
                        <td colspan="6" class="text-center text-red-400 py-8">
                            <i class="fa fa-exclamation-triangle text-2xl mb-2"></i>
                            <p class="zh">加载数据失败，请检查后端服务是否正常运行</p>
                            <p class="en hidden">Failed to load data, please check if the backend service is running</p>
                            <p class="text-sm mt-2">${error.message}</p>
                        </td>
                    </tr>
                `;
                balanceTableBodyLarge.innerHTML = errorHtml;
                balanceTableBodySmall.innerHTML = errorHtml;
            }
        }

        // 强制刷新数据（不使用缓存）
        async function loadFreshData() {
            console.log('强制刷新数据，跳过缓存检查...');

            // 显示加载状态
            const loadingHtml = `
                <tr>
                    <td colspan="6" class="text-center text-light/50 py-8">
                        <i class="fa fa-spinner fa-spin text-primary text-2xl mb-2"></i>
                        <p class="zh">正在刷新数据...</p>
                        <p class="en hidden">Refreshing data...</p>
                    </td>
                </tr>
            `;
            balanceTableBodyLarge.innerHTML = loadingHtml;
            balanceTableBodySmall.innerHTML = loadingHtml;

            // 直接执行请求逻辑（复制loadBalanceData的请求部分）
            await performDataRequest();
        }

        // 执行数据请求的通用逻辑
        async function performDataRequest() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/balances`, {
                    timeout: 10000, // 10秒超时
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // 处理响应数据
                handleApiResponse(await response.text());

            } catch (error) {
                const errorHtml = `
                    <tr>
                        <td colspan="6" class="text-center text-red-400 py-8">
                            <i class="fa fa-exclamation-triangle text-2xl mb-2"></i>
                            <p class="zh">加载数据失败，请检查后端服务是否正常运行</p>
                            <p class="en hidden">Failed to load data, please check if the backend service is running</p>
                            <p class="text-sm mt-2">${error.message}</p>
                        </td>
                    </tr>
                `;
                balanceTableBodyLarge.innerHTML = errorHtml;
                balanceTableBodySmall.innerHTML = errorHtml;
            }
        }

        async function loadBalanceData() {
            console.log('开始加载持仓数据...');

            // 检查本地存储中的缓存数据
            const cachedData = getCachedData();
            if (cachedData) {
                console.log('使用缓存数据，避免重复请求');

                // 直接处理缓存数据
                try {
                    const allUsers = cachedData.data.users;
                    const threshold = 100000000; // 1亿

                    // 将用户数据分成两组
                    usersLarge = allUsers.filter(user => (user.totalBalance || 0) >= threshold);
                    usersSmall = allUsers.filter(user => (user.totalBalance || 0) < threshold);

                    // 更新 tab 计数
                    tabLargeCount.textContent = `(${usersLarge.length})`;
                    tabSmallCount.textContent = `(${usersSmall.length})`;

                    // 重置排序状态
                    sortState.large = { field: null, order: null };
                    sortState.small = { field: null, order: null };
                    updateSortIcons();

                    // 更新统计信息（标记为来自缓存）
                    updateStatistics(cachedData.data, true);

                    // 渲染两个表格
                    renderSortedTable('large');
                    renderSortedTable('small');

                    console.log(`缓存数据已加载，最后更新时间: ${cachedData.data.lastUpdate}`);
                    console.log(`持仓≥1亿: ${usersLarge.length}人，持仓<1亿: ${usersSmall.length}人`);
                } catch (error) {
                    console.error('处理缓存数据失败:', error);
                    // 如果缓存数据损坏，清除缓存并重新请求
                    localStorage.removeItem(CACHE_KEY);
                    console.log('缓存数据损坏，已清除，重新请求数据');
                    loadFreshData(); // 重新调用，不检查缓存
                }
                return;
            }

            // 没有缓存数据，显示加载动画并请求
            // 显示加载状态
            const loadingHtml = `
                <tr>
                    <td colspan="6" class="text-center text-light/50 py-8">
                        <i class="fa fa-spinner fa-spin text-primary text-2xl mb-2"></i>
                        <p class="zh">正在加载数据...</p>
                        <p class="en hidden">Loading data...</p>
                    </td>
                </tr>
            `;
            balanceTableBodyLarge.innerHTML = loadingHtml;
            balanceTableBodySmall.innerHTML = loadingHtml;

            await performDataRequest();
        }

        function renderTableHTML(users) {
            if (!users || users.length === 0) {
                return `
                    <tr>
                        <td colspan="6" class="text-center text-light/50 py-8">
                            <i class="fa fa-info-circle text-2xl mb-2"></i>
                            <p class="zh">暂无用户数据</p>
                            <p class="en hidden">No user data available</p>
                        </td>
                    </tr>
                `;
            }

            let tableHtml = '';

            users.forEach((user) => {
                // 地址列表HTML
                const addressesHtml = user.addresses.map((address, index) => {
                    const shortAddress = `${address.slice(0, 6)}...${address.slice(-4)}`;
                    return `
                        <div class="flex items-center mb-1 last:mb-0">
                            <span class="text-light/70 font-mono text-sm">${shortAddress}</span>
                            <button onclick="navigator.clipboard.writeText('${address}')" class="ml-2 text-primary hover:text-secondary flex-shrink-0" title="复制地址">
                                <i class="fa fa-copy text-xs"></i>
                            </button>
                        </div>
                    `;
                }).join('');

                // 持仓列表HTML
                const balancesHtml = user.currentBalances.map((balance) => {
                    return `<div class="text-white font-mono text-sm mb-1 last:mb-0">${Math.round(balance).toLocaleString()}</div>`;
                }).join('');

                // 百分比样式
                let percentageClass = 'text-light/70';
                let percentageIcon = '';

                if (user.percentage > 0) {
                    percentageClass = 'text-success';
                    percentageIcon = '<i class="fa fa-arrow-up mr-1"></i>';
                } else if (user.percentage < 0) {
                    percentageClass = 'text-danger';
                    percentageIcon = '<i class="fa fa-arrow-down mr-1"></i>';
                }

                tableHtml += `
                    <tr class="border-b border-primary/10">
                        <td class="py-3 text-white font-medium min-w-[100px] w-[120px] align-middle">${user.nickname}</td>
                        <td class="py-3 text-light/70 min-w-[120px] w-[150px] align-middle">${addressesHtml}</td>
                        <td class="py-3 text-white font-mono min-w-[120px] w-[140px] align-middle">${balancesHtml}</td>
                        <td class="py-3 text-white font-mono min-w-[130px] w-[150px] align-middle">${Math.round(user.totalBalance).toLocaleString()}</td>
                        <td class="py-3 text-white font-mono min-w-[130px] w-[150px] align-middle">${Math.round(user.initialBalanceTotal).toLocaleString()}</td>
                        <td class="py-3 min-w-[100px] w-[120px] align-middle"><span class="${percentageClass}">${percentageIcon}${user.percentage.toFixed(2)}%</span></td>
                    </tr>
                `;
            });

            return tableHtml;
        }
    </script>
</body>
</html>
